!(function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],a):a(CodeMirror)})((function(a){"use strict";function b(a,b){if(this.cm=a,this.options=b,this.widget=null,this.debounce=0,this.tick=0,this.startPos=this.cm.getCursor("start"),this.startLen=this.cm.getLine(this.startPos.line).length-this.cm.getSelection().length,this.options.updateOnCursorActivity){var c=this;a.on("cursorActivity",this.activityFunc=function(){c.cursorActivity()})}}function c(a,b,c){var d=a.options.hintOptions,e={};for(var f in o)e[f]=o[f];if(d)for(var f in d)void 0!==d[f]&&(e[f]=d[f]);if(c)for(var f in c)void 0!==c[f]&&(e[f]=c[f]);return e.hint.resolve&&(e.hint=e.hint.resolve(a,b)),e}function d(a){return"string"==typeof a?a:a.text}function e(a,b){function c(a,c){var e;e="string"!=typeof c?function(a){return c(a,b)}:d.hasOwnProperty(c)?d[c]:c,f[a]=e}var d={Up:function(){b.moveFocus(-1)},Down:function(){b.moveFocus(1)},PageUp:function(){b.moveFocus(1-b.menuSize(),!0)},PageDown:function(){b.moveFocus(b.menuSize()-1,!0)},Home:function(){b.setFocus(0)},End:function(){b.setFocus(b.length-1)},Enter:b.pick,Tab:b.pick,Esc:b.close};/Mac/.test(navigator.platform)&&(d["Ctrl-P"]=function(){b.moveFocus(-1)},d["Ctrl-N"]=function(){b.moveFocus(1)});var e=a.options.customKeys,f=e?{}:d;if(e)for(var g in e)e.hasOwnProperty(g)&&c(g,e[g]);var h=a.options.extraKeys;if(h)for(var g in h)h.hasOwnProperty(g)&&c(g,h[g]);return f}function f(a,b){for(;b&&b!=a;){if("LI"===b.nodeName.toUpperCase()&&b.parentNode==a)return b;b=b.parentNode}}function g(b,c){this.completion=b,this.data=c,this.picked=!1;var g=this,h=b.cm,i=h.getInputField().ownerDocument,j=i.defaultView||i.parentWindow,m=this.hints=i.createElement("ul"),n=b.cm.options.theme;m.className="CodeMirror-hints "+n,this.selectedHint=c.selectedHint||0;for(var o=c.list,p=0;p<o.length;++p){var q=m.appendChild(i.createElement("li")),r=o[p],s=k+(p!=this.selectedHint?"":" "+l);null!=r.className&&(s=r.className+" "+s),q.className=s,r.render?r.render(q,c,r):q.appendChild(i.createTextNode(r.displayText||d(r))),q.hintId=p}var t=b.options.container||i.body,u=h.cursorCoords(b.options.alignWithWord?c.from:null),v=u.left,w=u.bottom,x=!0,y=0,z=0;if(t!==i.body){var A=-1!==["absolute","relative","fixed"].indexOf(j.getComputedStyle(t).position),B=A?t:t.offsetParent,C=B.getBoundingClientRect(),D=i.body.getBoundingClientRect();y=C.left-D.left-B.scrollLeft,z=C.top-D.top-B.scrollTop}m.style.left=v-y+"px",m.style.top=w-z+"px";var E=j.innerWidth||Math.max(i.body.offsetWidth,i.documentElement.offsetWidth),F=j.innerHeight||Math.max(i.body.offsetHeight,i.documentElement.offsetHeight);t.appendChild(m);var G,H=b.options.moveOnOverlap?m.getBoundingClientRect():new DOMRect,I=!!b.options.paddingForScrollbar&&m.scrollHeight>m.clientHeight+1;if(setTimeout((function(){G=h.getScrollInfo()})),H.bottom-F>0){var J=H.bottom-H.top;if(u.top-(u.bottom-H.top)-J>0)m.style.top=(w=u.top-J-z)+"px",x=!1;else if(J>F){m.style.height=F-5+"px",m.style.top=(w=u.bottom-H.top-z)+"px";var K=h.getCursor();c.from.ch!=K.ch&&(u=h.cursorCoords(K),m.style.left=(v=u.left-y)+"px",H=m.getBoundingClientRect())}}var L=H.right-E;if(L>0&&(H.right-H.left>E&&(m.style.width=E-5+"px",L-=H.right-H.left-E),m.style.left=(v=u.left-L-y)+"px"),I)for(var M=m.firstChild;M;M=M.nextSibling)M.style.paddingRight=h.display.nativeBarWidth+"px";if(h.addKeyMap(this.keyMap=e(b,{moveFocus:function(a,b){g.changeActive(g.selectedHint+a,b)},setFocus:function(a){g.changeActive(a)},menuSize:function(){return g.screenAmount()},length:o.length,close:function(){b.close()},pick:function(){g.pick()},data:c})),b.options.closeOnUnfocus){var N;h.on("blur",this.onBlur=function(){N=setTimeout((function(){b.close()}),100)}),h.on("focus",this.onFocus=function(){clearTimeout(N)})}h.on("scroll",this.onScroll=function(){var a=h.getScrollInfo(),c=h.getWrapperElement().getBoundingClientRect(),d=w+G.top-a.top,e=d-(j.pageYOffset||(i.documentElement||i.body).scrollTop);if(x||(e+=m.offsetHeight),e<=c.top||e>=c.bottom)return b.close();m.style.top=d+"px",m.style.left=v+G.left-a.left+"px"}),a.on(m,"dblclick",(function(a){var b=f(m,a.target||a.srcElement);b&&null!=b.hintId&&(g.changeActive(b.hintId),g.pick())})),a.on(m,"click",(function(a){var c=f(m,a.target||a.srcElement);c&&null!=c.hintId&&(g.changeActive(c.hintId),b.options.completeOnSingleClick&&g.pick())})),a.on(m,"mousedown",(function(){setTimeout((function(){h.focus()}),20)}));var O=this.getSelectedHintRange();return 0===O.from&&0===O.to||this.scrollToActive(),a.signal(c,"select",o[this.selectedHint],m.childNodes[this.selectedHint]),!0}function h(a,b){if(!a.somethingSelected())return b;for(var c=[],d=0;d<b.length;d++)b[d].supportsSelection&&c.push(b[d]);return c}function i(a,b,c,d){if(a.async)a(b,d,c);else{var e=a(b,c);e&&e.then?e.then(d):d(e)}}function j(b,c){var d,e=b.getHelpers(c,"hint");if(e.length){var f=function(a,b,c){function d(e){if(e==f.length)return b(null);i(f[e],a,c,(function(a){a&&a.list.length>0?b(a):d(e+1)}))}var f=h(a,e);d(0)};return f.async=!0,f.supportsSelection=!0,f}return(d=b.getHelper(b.getCursor(),"hintWords"))?function(b){return a.hint.fromList(b,{words:d})}:a.hint.anyword?function(b,c){return a.hint.anyword(b,c)}:function(){}}var k="CodeMirror-hint",l="CodeMirror-hint-active";a.showHint=function(a,b,c){if(!b)return a.showHint(c);c&&c.async&&(b.async=!0);var d={hint:b};if(c)for(var e in c)d[e]=c[e];return a.showHint(d)},a.defineExtension("showHint",(function(d){d=c(this,this.getCursor("start"),d);var e=this.listSelections();if(!(e.length>1)){if(this.somethingSelected()){if(!d.hint.supportsSelection)return;for(var f=0;f<e.length;f++)if(e[f].head.line!=e[f].anchor.line)return}this.state.completionActive&&this.state.completionActive.close();var g=this.state.completionActive=new b(this,d);g.options.hint&&(a.signal(this,"startCompletion",this),g.update(!0))}})),a.defineExtension("closeHint",(function(){this.state.completionActive&&this.state.completionActive.close()}));var m=window.requestAnimationFrame||function(a){return setTimeout(a,1e3/60)},n=window.cancelAnimationFrame||clearTimeout;b.prototype={close:function(){this.active()&&(this.cm.state.completionActive=null,this.tick=null,this.options.updateOnCursorActivity&&this.cm.off("cursorActivity",this.activityFunc),this.widget&&this.data&&a.signal(this.data,"close"),this.widget&&this.widget.close(),a.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(b,c){var e=b.list[c],f=this;this.cm.operation((function(){e.hint?e.hint(f.cm,b,e):f.cm.replaceRange(d(e),e.from||b.from,e.to||b.to,"complete"),a.signal(b,"pick",e),f.cm.scrollIntoView()})),this.options.closeOnPick&&this.close()},cursorActivity:function(){this.debounce&&(n(this.debounce),this.debounce=0);var a=this.startPos;this.data&&(a=this.data.from);var b=this.cm.getCursor(),c=this.cm.getLine(b.line);if(b.line!=this.startPos.line||c.length-b.ch!=this.startLen-this.startPos.ch||b.ch<a.ch||this.cm.somethingSelected()||!b.ch||this.options.closeCharacters.test(c.charAt(b.ch-1)))this.close();else{var d=this;this.debounce=m((function(){d.update()})),this.widget&&this.widget.disable()}},update:function(a){if(null!=this.tick){var b=this,c=++this.tick;i(this.options.hint,this.cm,this.options,(function(d){b.tick==c&&b.finishUpdate(d,a)}))}},finishUpdate:function(b,c){this.data&&a.signal(this.data,"update");var d=this.widget&&this.widget.picked||c&&this.options.completeSingle;this.widget&&this.widget.close(),this.data=b,b&&b.list.length&&(d&&1==b.list.length?this.pick(b,0):(this.widget=new g(this,b),a.signal(b,"shown")))}},g.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode&&this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var a=this.completion.cm;this.completion.options.closeOnUnfocus&&(a.off("blur",this.onBlur),a.off("focus",this.onFocus)),a.off("scroll",this.onScroll)}},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var a=this;this.keyMap={Enter:function(){a.picked=!0}},this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(b,c){if(b>=this.data.list.length?b=c?this.data.list.length-1:0:b<0&&(b=c?0:this.data.list.length-1),this.selectedHint!=b){var d=this.hints.childNodes[this.selectedHint];d&&(d.className=d.className.replace(" "+l,"")),d=this.hints.childNodes[this.selectedHint=b],d.className+=" "+l,this.scrollToActive(),a.signal(this.data,"select",this.data.list[this.selectedHint],d)}},scrollToActive:function(){var a=this.getSelectedHintRange(),b=this.hints.childNodes[a.from],c=this.hints.childNodes[a.to],d=this.hints.firstChild;b.offsetTop<this.hints.scrollTop?this.hints.scrollTop=b.offsetTop-d.offsetTop:c.offsetTop+c.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=c.offsetTop+c.offsetHeight-this.hints.clientHeight+d.offsetTop)},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1},getSelectedHintRange:function(){var a=this.completion.options.scrollMargin||0;return{from:Math.max(0,this.selectedHint-a),to:Math.min(this.data.list.length-1,this.selectedHint+a)}}},a.registerHelper("hint","auto",{resolve:j}),a.registerHelper("hint","fromList",(function(b,c){var d,e=b.getCursor(),f=b.getTokenAt(e),g=a.Pos(e.line,f.start),h=e;f.start<e.ch&&/\w/.test(f.string.charAt(e.ch-f.start-1))?d=f.string.substr(0,e.ch-f.start):(d="",g=e);for(var i=[],j=0;j<c.words.length;j++){var k=c.words[j];k.slice(0,d.length)==d&&i.push(k)}if(i.length)return{list:i,from:g,to:h}})),a.commands.autocomplete=a.showHint;var o={hint:a.hint.auto,completeSingle:!0,alignWithWord:!0,closeCharacters:/[\s()\[\]{};:>,]/,closeOnPick:!0,closeOnUnfocus:!0,updateOnCursorActivity:!0,completeOnSingleClick:!0,container:null,customKeys:null,extraKeys:null,paddingForScrollbar:!0,moveOnOverlap:!0};a.defineOption("hintOptions",null)}));